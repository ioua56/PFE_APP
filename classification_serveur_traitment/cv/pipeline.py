from cv.repository.repository import *


class Pipeline:
    def __init__(self, tasks):
        discover_services()
        self.repository = Repository()
        #self.tasks = tasks
        #self.fetch_task_handler()

    def fetch_task_handler(self):
        self.pipeline = []
        for task in self.tasks:
            service = self.repository.get_service(task['model'])
            service.configure(task['config'])
            self.pipeline.append(service)

    def run(self, image):
        out = image
        for task in self.pipeline:
            out = task.run(out)
        return out

'''
configs = {"tasks": [
         {
             "name": "facedetection",
             "model": "RetinaFace",
             "config": {}
         },
         {
             "name": "facerecognition",
             "model": "OpenFace",
             "config": {
                "db": {
                    "persons": [
                        {
                            "first_name": "Fethi",
                            "last_name": "Ourghi"
                        },
                        {
                            "first_name": "Mohamed",
                            "last_name": "Chenider"
                        }
                    ],
                    "encodings": [
                        [
                            -0.032768614590168,
                            0.04137662053108215,
                            0.11884863674640656,
                            0.17694218456745148,
                            0.038350388407707214,
                            0.19822098314762115,
                            -0.011815709061920643,
                            -0.22613070905208588,
                            0.016084667295217514,
                            -0.06248699501156807,
                            -0.022836264222860336,
                            0.11944761872291565,
                            -0.09183810651302338,
                            -0.11080717295408249,
                            -0.009931610897183418,
                            0.006702421233057976,
                            -0.0429181344807148,
                            0.13447630405426025,
                            0.005541671998798847,
                            -0.003408188698813319,
                            0.024835066869854927,
                            -0.009813660755753517,
                            -0.004241690505295992,
                            0.17006078362464905,
                            0.05471992492675781,
                            0.0037379555869847536,
                            -0.1222769170999527,
                            -0.12824150919914246,
                            -0.053003501147031784,
                            0.025976603850722313,
                            0.1176341250538826,
                            0.15599162876605988,
                            -0.08226575702428818,
                            0.04918535426259041,
                            0.11738795042037964,
                            0.07762657850980759,
                            0.014681128785014153,
                            -0.054034020751714706,
                            0.03086034767329693,
                            -0.05304265022277832,
                            0.1311766654253006,
                            -0.0461626797914505,
                            0.039965879172086716,
                            -0.12987743318080902,
                            -0.036288052797317505,
                            -0.0916820839047432,
                            0.12011387199163437,
                            -0.05007101222872734,
                            -0.0754246711730957,
                            -0.009942088276147842,
                            0.08469174057245255,
                            -0.08021433651447296,
                            0.11935830116271973,
                            -0.021051213145256042,
                            0.08909386396408081,
                            0.09087542444467545,
                            0.014530818909406662,
                            0.07115107029676437,
                            -0.024924665689468384,
                            -0.015356350690126419,
                            -0.0682767704129219,
                            0.11909017711877823,
                            0.07149186730384827,
                            -0.2529657483100891,
                            0.19952234625816345,
                            0.0728573128581047,
                            0.04941512271761894,
                            -0.15995638072490692,
                            -0.22643443942070007,
                            0.2029319852590561,
                            -0.04069531336426735,
                            0.07637359201908112,
                            -0.04059509187936783,
                            0.0979829803109169,
                            0.006664654240012169,
                            -0.007591888774186373,
                            0.0130135677754879,
                            -0.00766725605353713,
                            -0.017386043444275856,
                            -0.06292912364006042,
                            -0.0554216168820858,
                            0.15768179297447205,
                            0.013708612881600857,
                            -0.03567696735262871,
                            -0.028343630954623222,
                            -0.0587063767015934,
                            0.0014858250506222248,
                            -0.00991129782050848,
                            -0.14913661777973175,
                            0.07196051627397537,
                            0.060209378600120544,
                            -0.018586087971925735,
                            0.09772820770740509,
                            0.020224502310156822,
                            0.010129934176802635,
                            0.06040159985423088,
                            0.01764857769012451,
                            0.06020886451005936,
                            0.044190794229507446,
                            0.05565693601965904,
                            0.024202827364206314,
                            -0.021981004625558853,
                            -0.1194818988442421,
                            0.038985807448625565,
                            0.09672665596008301,
                            0.054128170013427734,
                            0.09877419471740723,
                            -0.10660967975854874,
                            -0.09274324774742126,
                            0.07866692543029785,
                            -0.10864254087209702,
                            0.036764949560165405,
                            0.09919879585504532,
                            -0.07594031095504761,
                            0.055501826107501984,
                            -0.05807795375585556,
                            -0.0593743696808815,
                            -0.01187159400433302,
                            -0.0007390312384814024,
                            0.06911562383174896,
                            0.11559200286865234,
                            -0.03572489693760872,
                            0.00901801697909832,
                            -0.10695484280586243,
                            0.004213598091155291,
                            0.18684566020965576,
                            0.04480689391493797,
                            -0.030994851142168045
                        ],
                        [
                            0.0431150421500206,
                            0.132274329662323,
                            -0.12827180325984955,
                            -0.013263191096484661,
                            0.021268459036946297,
                            0.11392591893672943,
                            -0.010207249782979488,
                            -0.06769359856843948,
                            -0.11028347909450531,
                            0.1448325663805008,
                            0.09181726723909378,
                            0.027607323601841927,
                            0.12125006318092346,
                            -0.046222053468227386,
                            -0.06081574410200119,
                            0.03745089843869209,
                            0.0031654401682317257,
                            0.1662079095840454,
                            0.005259124096482992,
                            0.12937377393245697,
                            0.11921200901269913,
                            -0.11296475678682327,
                            0.090852290391922,
                            0.07936903834342957,
                            -0.01762905716896057,
                            0.030834166333079338,
                            0.00910409726202488,
                            -0.16756528615951538,
                            0.12393727898597717,
                            0.16500210762023926,
                            -0.07160634547472,
                            0.10916684567928314,
                            0.04012196511030197,
                            0.03445040434598923,
                            0.03130142018198967,
                            -0.01338000874966383,
                            -0.006135810166597366,
                            0.15894846618175507,
                            0.016761790961027145,
                            -0.11825522035360336,
                            -0.1072067990899086,
                            -0.1413816660642624,
                            -0.0010489614214748144,
                            0.11950427293777466,
                            -0.14528276026248932,
                            -0.014713122509419918,
                            0.18651975691318512,
                            0.04840525984764099,
                            -0.20827032625675201,
                            0.013773960061371326,
                            0.08582991361618042,
                            0.07049287110567093,
                            -0.05120789632201195,
                            0.009110555052757263,
                            0.07158055901527405,
                            0.05088983476161957,
                            0.047899406403303146,
                            0.03945421054959297,
                            0.016578922048211098,
                            -0.13915765285491943,
                            -0.05864640325307846,
                            -0.09985179454088211,
                            0.223671093583107,
                            -0.11924967914819717,
                            0.10632109642028809,
                            -0.04403700679540634,
                            -0.06987818330526352,
                            -0.004937262739986181,
                            -0.11067915707826614,
                            0.11943896859884262,
                            -0.06918834149837494,
                            0.005160030908882618,
                            -0.13009114563465118,
                            -0.034862712025642395,
                            -0.02125733532011509,
                            -0.07852322608232498,
                            0.02771863527595997,
                            0.11580738425254822,
                            0.03681274130940437,
                            -0.019512133672833443,
                            -0.08790276944637299,
                            0.03028818964958191,
                            -0.06424709409475327,
                            -0.04609476402401924,
                            -0.014985424466431141,
                            -0.033856894820928574,
                            -0.03157690539956093,
                            0.0022306034807115793,
                            0.1578810214996338,
                            0.08819780498743057,
                            0.031702831387519836,
                            -0.09711217135190964,
                            -0.07324923574924469,
                            0.001306326943449676,
                            0.017750712111592293,
                            -0.09099180996417999,
                            -0.01755906082689762,
                            0.19954580068588257,
                            0.06137024983763695,
                            -0.09048265218734741,
                            0.08962701261043549,
                            0.07886980473995209,
                            -0.010164462961256504,
                            0.10781841725111008,
                            -0.03804804012179375,
                            0.06705722212791443,
                            -0.01992032304406166,
                            0.0648052766919136,
                            0.12064971774816513,
                            -0.10272212326526642,
                            -0.06098543107509613,
                            0.13105687499046326,
                            -0.048591725528240204,
                            -0.015448858961462975,
                            0.10052499175071716,
                            -0.004484957084059715,
                            -0.008550344966351986,
                            -0.17230139672756195,
                            0.08360748738050461,
                            0.12774556875228882,
                            0.044183164834976196,
                            -0.07427270710468292,
                            0.03331267088651657,
                            0.03554240241646767,
                            -0.03930338844656944,
                            0.06270338594913483,
                            0.10576535016298294,
                            0.0011805706890299916
                        ]
                    ]
                }
            }
         }
         ]
         }


pipeline = Pipeline(configs)
pipeline.fetch_task_handler()
pipeline.run("image")

'''
